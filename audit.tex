


\noindent This chapter presents an audit of Everscalend's smart contracts and lists the issues that were encoured in the source code.


\begin{figure}[hbt!]

\listoffigures
\end{figure}




\section{General remarks}

In this section we present some recurrent issues that were encountered in the source code and some general good practices that should be respected. 

%\subsection{Typography of Static Variables}
%\label{readability:static}

%A good coding convention is to use typography to visually discriminate static variables from other variables, for example using a prefix such as {\tt s\_}.

%\subsection{Typography of Global Variables}
%\label{readability:global}

%A good coding convention is to use typography to visually discriminate global variables from local variables, for example using a prefix such as {\tt m\_} or {\tt g\_}.

\subsection{Typography of Internal Functions}
\label{readability:internal}

A good coding convention is to use typography to visually discriminate public functions and internal functions, for example using a prefix such as {\tt \_}.

%\subsection{Accept Methods without Checks}
%\label{accept:all}

%Public methods using {\tt tvm.accept()} without any prior check should not exist. Indeed, such methods could be used by attackers to drain the balance of the contracts, even with minor amounts but unlimited number of messages.

\subsection{Constructors without checks}
\label{constructor:check}

Contract constructors should always at the very least verify that the contract's public key is set and that the deployer is the owner of the contract. This is important especially in the case in which the contract has arguments that set the state variables. If it is not done, it opens the gate to various kinds of attacks.

\section{Contract deployment from Platform}

\issueCritical{Unprotected constructors in many contracts}{
  See \ref{constructor:check}. 
  
  Other than the `RootTokenContract` and `TONTokenWallet` contracts, all the other contracts have unprotected constructors and a comment that says that the contract will be deployed from the Platform. That does mean that is no longer necessary to check that the deployer of the contract is the owner of the contract. It is especially dangerous in the contracts which set the owner through the constructor like: `MarketAggregator`, `BorrowModule`, `LiquidationModule`, `RepayModule`, `SupplyModule`, `WithdrawModule`, `Oracle`, `TIP3TokenDeployer`, `UserAccount`, `UserAccountManager`, `Platform` and `WalletController`.
}

\subsection{Possible attack}

It makes it possible to perform phishing attacks by deploying fake contracts with which the users can interact with. So instead of interacting with the real contract they interact with the fake. 

If a malicious user deploys a fake `UserAccountManager` which will deploy user's accounts. And one of the users requests a withdraw of their tokens. The owner of the fake `UserAccountManager` can either block the transaction stopping the user's from withdrawing their tokens, or ask them for a fee before processing their request.

%In a less likely way, if another user has the address of the owner, they can deploy the contract as if they were the owner before he does and impersonate him, making them able to control a fake system to their own interest. 

%\section{Address setting and updating}

%\issueCritical{No checks before setting}{}

%\subsection{Possible attack}

\section{Internal function names}

\issueMinor{Internal function names}{
  See \ref{readability:internal}. 

  The functions {\tt performOperation} and {\tt updatePrice} in the {\tt MarketAggregator} contract (file: "MarketsAggregator.sol"). are internal so their names should start with `\_`.
}

\section{Undefined functions}

\issueMinor{Undefined functions}{
  The functions {\tt calculateUtilizationRate}, {\tt calculateBorrowingRate} and {\tt calculateExchangeRate} in the `MarketMath` library (file: "MarketMath.sol") are undefined and unused. Defining and using them appropriately would significantly improve the readability of the source code.
}

\section{Unused functions}

\issueMinor{Unused functions}{
  The functions: 
  \begin{itemize}
    \item {\tt calculateExchangeRate} in the {\tt MarketMath} library (file: "MarketMath.sol")
    \item {\tt calculateU}, {\tt calculateTotalReserves}, {\tt calculateNewIndex}, {\tt calculateTotalBorrowed} and {\tt calculateReserves} in the {\tt MarketOperations} library (file: "MarketOperations.sol")
    \item {\tt \_calculateBorrowInfo} in the {\tt MarketAggregator} conract (file: "MarketsAggregator.sol")
  \end{itemize}
  And all the functions from the {\tt MarketToUserPayloads} library (file: "MarketPayloads.sol") and {\tt TvmCellOperations} library (file: "TvmCellOperations.sol") are unused. Unused functions should be removed from the code as they are useless and they clutter the code.
}

\section{Unused modifiers}

\issueMinor{Unused modifiers}{
  The modifiers: 
  \begin{itemize}
    \item {\tt onlySelf}, {\tt onlyRealTokenRoot} and {\tt onlyExecutor} in the {\tt MarketAggregator} contract (file: "MarketsAggregator.sol")
    \item {\tt onlyMarket} in the {\tt WalletController} conract (file: "WalletController.sol")
  \end{itemize}
  Are unused. Unused modifiers should be removed from the code as they are useless and they clutter the code.
}

\input{audit/Giver.tex} %ignored for now
\input{audit/MarketMath.tex}
\input{audit/MarketOperations.tex}
\input{audit/MarketPayloads.tex}
\input{audit/MarketsAggregator.tex}

\input{audit/IModule.tex}
\input{audit/BorrowModule.tex}
\input{audit/LiquidationModule.tex}
\input{audit/RepayModule.tex}
\input{audit/SupplyModule.tex}
\input{audit/WithdrawModule.tex}

\input{audit/Oracle.tex}
\input{audit/TIP3Deployer.tex}
\input{audit/IUserAccount.tex}
\input{audit/UserAccount.tex}
\input{audit/UserAccountManager.tex}
\input{audit/WalletController.tex}

\input{audit/IRoles.tex}
\input{audit/Platform.tex}
\input{audit/RootTokenContract.tex}
\input{audit/TONTokenWallet.tex}
\input{audit/FloatingPointOperations.tex}
\input{audit/TvmCellOperations.tex}
